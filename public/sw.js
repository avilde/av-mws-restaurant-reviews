const APP_NAME="av-rr",DEBUG_MODE=!0,MAP_API_KEY="AIzaSyCSPE2b5yv7k7CvRctNKvGl42FXfMr-DeU",STATIC_MAP_API_KEY="AIzaSyBC8fMCdTyXKxZmNEe6aMXOIoM6AR_Pgak";function d(...e){DEBUG_MODE&&console.info(`[${APP_NAME}]`,...e)}stringToBoolean=(e=>{if("string"==typeof e)switch(e.toLowerCase().trim()){case"true":case"yes":case!0:case"1":return!0;case"false":case"no":case!1:case"0":case null:return!1}return Boolean(e)});const CACHE_NAME=`${APP_NAME}-static-1`,cachedFiles=["/index.html","/restaurant.html","/img/1.webp","/img/2.webp","/img/3.webp","/img/4.webp","/img/5.webp","/img/6.webp","/img/7.webp","/img/8.webp","/img/9.webp","/img/10.webp","/img/app-logo16.webp","/img/app-logo48.webp","/img/app-logo64.webp","/img/app-logo128.webp","/img/app-logo256.webp","/img/app-logo512.webp","img/google_map-w320_h400.webp","img/google_map-w412_h400.webp","img/google_map-w740_h400.webp","img/google_map-w1000_h400.webp","img/google_map-w1920_h400.webp","img/google_map-w2545_h400.webp","/sw.js","/manifest.json","/favicon.ico"];self.addEventListener("install",e=>{e.waitUntil(caches.open(CACHE_NAME).then(e=>e.addAll(cachedFiles)).catch(e=>d(`(install) caching error: ${e}`)))}),self.addEventListener("activate",e=>{e.waitUntil(caches.keys().then(e=>Promise.all(e.filter(e=>e.startsWith("av-rr-")&&e!==CACHE_NAME).map(e=>caches.delete(e)))).catch(e=>d(`(activate) caching error: ${e}`)))}),self.addEventListener("fetch",e=>{"GET"===e.request.method&&e.respondWith(caches.open(CACHE_NAME).then(t=>t.match(e.request).then(n=>n||fetch(e.request).then(n=>(t.put(e.request,n.clone()),n)).catch(e=>d(`(fetch) error: ${e}`))).catch(e=>d(`(fetch) exception in cache match. Error: ${e}`))).catch(e=>d(`(fetch) exception when openning cache ${CACHE_NAME}. Error: ${e}`)))});class DBHelper{static get REST_URL(){return"http://localhost:1337"}static get DB_NAME(){return APP_NAME}static get STORE_RESTAURANTS(){return"restaurants"}static get STORE_REVIEWS(){return"reviews"}static get DB_VER(){return 1}static getDb(){return idb.open(DBHelper.DB_NAME,DBHelper.DB_VER,e=>{e.createObjectStore(DBHelper.STORE_RESTAURANTS,{keyPath:"id",autoIncrement:!0}).createIndex("pending-updates","pendingUpdate",{unique:!1}),e.createObjectStore(DBHelper.STORE_REVIEWS,{keyPath:"id",autoIncrement:!0}).createIndex("pending-updates","pendingUpdate",{unique:!1})})}static fetchRestaurants(e){DBHelper.getDb().then(e=>{if(e)return e.transaction(DBHelper.STORE_RESTAURANTS).objectStore(DBHelper.STORE_RESTAURANTS).getAll()}).then(t=>{if(t&&t.length>0)return e(null,t);fetch(`${DBHelper.REST_URL}/${DBHelper.STORE_RESTAURANTS}`).then(e=>{if(200===e.status)return e.json();console.error(`Could not retrieve restaurants data. Status: ${response.status}`)}).then(t=>(DBHelper.getDb().then(e=>{if(!e)return;const n=e.transaction(DBHelper.STORE_RESTAURANTS,"readwrite").objectStore(DBHelper.STORE_RESTAURANTS);t.map(e=>{e.hasOwnProperty("pendingUpdate")||(e.pendingUpdate="no"),n.put(e)})}),e(null,t))).catch(e=>d(`request failed: ${e}`))})}static fetchReviewsById(e,t){DBHelper.getDb().then(e=>{if(e)return e.transaction(DBHelper.STORE_REVIEWS).objectStore(DBHelper.STORE_REVIEWS).getAll()}).then(n=>{if((n=n.filter(t=>t.restaurant_id===e))&&n.length>0)return t(null,n);fetch(`${DBHelper.REST_URL}/${DBHelper.STORE_REVIEWS}/?restaurant_id=${e}`).then(e=>{if(200===e.status)return e.json();console.error(`Could not retrieve reviews data. Status: ${response.status}`)}).then(e=>(e&&e.length>0&&e.map(e=>{e.hasOwnProperty("pendingUpdate")||(e.pendingUpdate="no"),e.createdAt=new Date(e.createdAt).valueOf(),e.updatedAt=new Date(e.updatedAt).valueOf()}),DBHelper.getDb().then(t=>{if(!t)return;const n=t.transaction(DBHelper.STORE_REVIEWS,"readwrite").objectStore(DBHelper.STORE_REVIEWS);e&&e.length>0&&e.map(e=>{n.put(e)})}),t(null,e)))}).catch(e=>d(`exception in getting reviews: ${e}`))}static fetchReviewsByRestaurantId(e,t){DBHelper.fetchReviewsById(e,(n,r)=>{if(n)t(n,null);else{r?t(null,r):t(`[${APP_NAME}] reviews for restaurant id '${e}' do not exist`,null)}})}static fetchRestaurantById(e,t){DBHelper.fetchRestaurants((n,r)=>{if(n)t(n,null);else{const n=r.find(t=>t.id==e);n?t(null,n):t(`[${APP_NAME}] restaurant '${n}' does not exist`,null)}})}static fetchRestaurantByCuisine(e,t){DBHelper.fetchRestaurants((n,r)=>{n?t(n,null):t(null,r.filter(t=>t.cuisine_type===e))})}static fetchRestaurantByNeighborhood(e,t){DBHelper.fetchRestaurants((n,r)=>{n?t(n,null):t(null,r.filter(t=>t.neighborhood===e))})}static fetchRestaurantByCuisineAndNeighborhood(e,t,n){DBHelper.fetchRestaurants((r,o)=>{if(r)n(r,null);else{let r=o;"all"!==e&&(r=r.filter(t=>t.cuisine_type===e)),"all"!==t&&(r=r.filter(e=>e.neighborhood===t)),n(null,r)}})}static fetchNeighborhoods(e){DBHelper.fetchRestaurants((t,n)=>{if(t)e(t,null);else{const t=n.map((e,t)=>n[t].neighborhood),r=t.filter((e,n)=>t.indexOf(e)===n);e(null,r)}})}static fetchCuisines(e){DBHelper.fetchRestaurants((t,n)=>{if(t)e(t,null);else{const t=n.map((e,t)=>n[t].cuisine_type),r=t.filter((e,n)=>t.indexOf(e)===n);e(null,r)}})}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static imageUrlForRestaurant(e){return e&&e.photograph?`img/${e.photograph}.webp`:"img/no-image.svg"}static mapMarkerForRestaurant(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:DBHelper.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}static favoriteRestaurant(e,t){e&&"boolean"==typeof t&&(e.is_favorite=t,fetch(`${DBHelper.REST_URL}/restaurants/${e.id}/?is_favorite=${t}`,{method:"PUT"}).then(t=>{200!=t.status&&console.info(`[${APP_NAME}] response was not successful. Response: ${t}`),e.pendingUpdate="no"}).catch(n=>{d(`put request failed. Could not ${t?"favorite":"unfavorite"} restaurant '${e.id}'. Error: ${n}`),e.pendingUpdate="yes"}),DBHelper.updateRestaurantInDb(e))}static updateRestaurantInDb(e,t){d("updating restaurant",e),DBHelper.getDb().then(n=>{n&&(n.transaction(DBHelper.STORE_RESTAURANTS,"readwrite").objectStore(DBHelper.STORE_RESTAURANTS).put(e),"function"==typeof t&&t())})}static insertReview(e){if(e)return e.hasOwnProperty("id")&&delete e.id,fetch(`${DBHelper.REST_URL}/reviews`,{method:"POST",body:JSON.stringify(e)}).then(t=>(201!=t.status&&(d(`response was not successful. Response: ${t}`),e.pendingUpdate="yes"),t.json())).then(t=>{d("record from server",t.id),t.hasOwnProperty("pendingUpdate")||(t.pendingUpdate="no"),t.createdAt=new Date(t.createdAt).valueOf(),t.updatedAt=new Date(t.updatedAt).valueOf(),e=t,DBHelper.insertReviewInDb(t,()=>{d("server record inserted",t.id)})}).catch(t=>(d(`post review request failed. Error: ${t}`),e.pendingUpdate="yes",DBHelper.insertReviewInDb(e,()=>{d("pending record inserted",e),e=e}),e)),e}static insertReviewInDb(e,t){DBHelper.getDb().then(n=>{n&&(n.transaction(DBHelper.STORE_REVIEWS,"readwrite").objectStore(DBHelper.STORE_REVIEWS).put(e),"function"==typeof t&&t())}).catch(e=>{d(`insert review in db failed. Error: ${e}`)})}static deleteReviewFromDb(e,t){DBHelper.getDb().then(n=>{n&&(n.transaction(DBHelper.STORE_REVIEWS,"readwrite").objectStore(DBHelper.STORE_REVIEWS).delete(e),d(`review ${e} deleted`),"function"==typeof t&&t())}).catch(e=>{d(`delete review from db failed. Error: ${e}`)})}static syncData(){DBHelper.getDb().then(e=>{if(e)return e.transaction(DBHelper.STORE_RESTAURANTS).objectStore(DBHelper.STORE_RESTAURANTS).index("pending-updates").openCursor("yes")}).then(function e(t){if(!t)return;let n=t.value;return n.pendingUpdate="no",DBHelper.favoriteRestaurant(n,n.is_favorite),t.continue().then(e)}),DBHelper.getDb().then(e=>{if(e)return e.transaction(DBHelper.STORE_REVIEWS).objectStore(DBHelper.STORE_REVIEWS).index("pending-updates").openCursor("yes")}).then(function e(t){if(!t)return;let n=t.value;return DBHelper.deleteReviewFromDb(n.id,()=>{n.pendingUpdate="no",DBHelper.insertReview(n)}),t.continue().then(e)})}}!function(){function e(e){return new Promise(function(t,n){e.onsuccess=function(){t(e.result)},e.onerror=function(){n(e.error)}})}function t(t,n,r){var o,i=new Promise(function(i,a){e(o=t[n].apply(t,r)).then(i,a)});return i.request=o,i}function n(e,t,n){n.forEach(function(n){Object.defineProperty(e.prototype,n,{get:function(){return this[t][n]},set:function(e){this[t][n]=e}})})}function r(e,n,r,o){o.forEach(function(o){o in r.prototype&&(e.prototype[o]=function(){return t(this[n],o,arguments)})})}function o(e,t,n,r){r.forEach(function(r){r in n.prototype&&(e.prototype[r]=function(){return this[t][r].apply(this[t],arguments)})})}function i(e,n,r,o){o.forEach(function(o){o in r.prototype&&(e.prototype[o]=function(){return e=this[n],(r=t(e,o,arguments)).then(function(e){if(e)return new s(e,r.request)});var e,r})})}function a(e){this._index=e}function s(e,t){this._cursor=e,this._request=t}function c(e){this._store=e}function u(e){this._tx=e,this.complete=new Promise(function(t,n){e.oncomplete=function(){t()},e.onerror=function(){n(e.error)},e.onabort=function(){n(e.error)}})}function p(e,t,n){this._db=e,this.oldVersion=t,this.transaction=new u(n)}function l(e){this._db=e}n(a,"_index",["name","keyPath","multiEntry","unique"]),r(a,"_index",IDBIndex,["get","getKey","getAll","getAllKeys","count"]),i(a,"_index",IDBIndex,["openCursor","openKeyCursor"]),n(s,"_cursor",["direction","key","primaryKey","value"]),r(s,"_cursor",IDBCursor,["update","delete"]),["advance","continue","continuePrimaryKey"].forEach(function(t){t in IDBCursor.prototype&&(s.prototype[t]=function(){var n=this,r=arguments;return Promise.resolve().then(function(){return n._cursor[t].apply(n._cursor,r),e(n._request).then(function(e){if(e)return new s(e,n._request)})})})}),c.prototype.createIndex=function(){return new a(this._store.createIndex.apply(this._store,arguments))},c.prototype.index=function(){return new a(this._store.index.apply(this._store,arguments))},n(c,"_store",["name","keyPath","indexNames","autoIncrement"]),r(c,"_store",IDBObjectStore,["put","add","delete","clear","get","getAll","getKey","getAllKeys","count"]),i(c,"_store",IDBObjectStore,["openCursor","openKeyCursor"]),o(c,"_store",IDBObjectStore,["deleteIndex"]),u.prototype.objectStore=function(){return new c(this._tx.objectStore.apply(this._tx,arguments))},n(u,"_tx",["objectStoreNames","mode"]),o(u,"_tx",IDBTransaction,["abort"]),p.prototype.createObjectStore=function(){return new c(this._db.createObjectStore.apply(this._db,arguments))},n(p,"_db",["name","version","objectStoreNames"]),o(p,"_db",IDBDatabase,["deleteObjectStore","close"]),l.prototype.transaction=function(){return new u(this._db.transaction.apply(this._db,arguments))},n(l,"_db",["name","version","objectStoreNames"]),o(l,"_db",IDBDatabase,["close"]),["openCursor","openKeyCursor"].forEach(function(e){[c,a].forEach(function(t){t.prototype[e.replace("open","iterate")]=function(){var t,n=(t=arguments,Array.prototype.slice.call(t)),r=n[n.length-1],o=this._store||this._index,i=o[e].apply(o,n.slice(0,-1));i.onsuccess=function(){r(i.result)}}})}),[a,c].forEach(function(e){e.prototype.getAll||(e.prototype.getAll=function(e,t){var n=this,r=[];return new Promise(function(o){n.iterateCursor(e,function(e){e?(r.push(e.value),void 0===t||r.length!=t?e.continue():o(r)):o(r)})})})});var d={open:function(e,n,r){var o=t(indexedDB,"open",[e,n]),i=o.request;return i.onupgradeneeded=function(e){r&&r(new p(i.result,e.oldVersion,i.transaction))},o.then(function(e){return new l(e)})},delete:function(e){return t(indexedDB,"deleteDatabase",[e])}};"undefined"!=typeof module?(module.exports=d,module.exports.default=module.exports):self.idb=d}();